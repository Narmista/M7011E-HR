<!DOCTYPE html>
  <head>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" type="text/javascript">
    </script>
  </head>
  <body onbeforeunload="return logout()">
	<script>
        $(document).ready(function() {
            main(); 
            setInterval(function(){
                main();
                blackOutCheck()
                if(document.getElementById("online").value !=""){
                    sendUser();
                }
            }, 1000); //5000 = 5s
        });

        const href = window.location.href;
        const auth = href.split('?')[1];
        var userSelected = false;

        function main(){
            $.ajax({
                type: 'get',
                url: 'http://54.197.39.195:3000/user/tokenExpire',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    $.ajax({
                        type: 'get',
                        url: 'http://54.197.39.195:3000/user/tokenZero',
                        headers: {
                            'Authorization': 'Bearer ' + auth
                        },
                        error: function (data) {
                            console.debug(data);
                        },
                        success: function (json) {
                            alert("You have been logged in for too long, please login again!");
                            window.location.replace('http://localhost:8000');
                        }
                    });
                },
                success: function (json) {
                }
            });
            $.ajax({
                type: 'get',
                url: 'http://54.197.39.195:3000/user/getImage',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    if(typeof json.icon != "undefined"){
                        $("#myManagerImg").attr('src','http://54.197.39.195:3000/' + json.icon);
                        $("#myManagerImg").attr('style','');
                    }
                }
            });
            $.ajax({
                type: 'get',
                url: 'http://54.197.39.195:3000/powerPlant/status',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    setStatus(json.status);
                }
            });
            $.ajax({
                type: 'get',
                url: 'http://54.197.39.195:3000/user/getTotalNetProduction',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    var tot = 0;
                    var length = Object.keys(json.user).length;
                    for(length; length > 0; length--){
                        tot = tot + json.user[length-1].netProduction;
                    }
                    document.getElementById("totalNetProduction").innerHTML = Math.round(tot);
                    document.getElementById("recommendedPrice").innerHTML = Math.round(tot)/10;
                }
            });
            $.ajax({
                type: 'get',
                url: 'http://54.197.39.195:3000/powerplant/getPrice',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    
                 document.getElementById("currentPrice").innerHTML = json.price;
                }
            });
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/powerplant/producePower',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }
        function setStatus(status){
            if(status == 0){
                status = "stopped";
                setProduction(0);
            } else if(status == 1){
                status = "starting";
                setProduction(0);
            }else if(status == 2){
                status = "running";
                getProduction();
            }  
            document.getElementById("status").innerHTML = status;
        }
        function getProduction(){
            $.ajax({
                type: 'get',
                url: 'http://54.197.39.195:3000/powerPlant/production',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json){
                    setProduction(json.production);
                }
            });
        }
        function setProduction(production){
            document.getElementById("production").innerHTML = production;
            setBuffer(production);
        }
        function upload(){
            var file_data = $('#file').prop('files')[0];
            var form_data = new FormData();
            form_data.append('avatar', file_data);
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/uploadImage',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                cache: false,
                contentType: false,
                processData: false,
                enctype: 'multipart/form-data',
                data: form_data,
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }
        function changeUser() {
            var username = document.getElementById("username").value;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/changeUser',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {username: username},
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Username has been changed, please login again!')
                    window.location.replace('http://localhost:8000');
                }
            });
        }
        function changeName() {
            var name = document.getElementById("name").value;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/changeName',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {name: name},
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Name has been changed, please login again!')
                    window.location.replace('http://localhost:8000');
                }
            });
        }
        function changePass() {
            var password = document.getElementById("password").value;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/changePass',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {password: password},
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Password has been changed, please login again!')
                    window.location.replace('http://localhost:8000');
                }
            });
        }	
        function deleteAcc() {
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/delete',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Your account has been deleted')
                    window.location.replace('http://localhost:8000');
                }
            });
        }	
        function startPlant() {
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/powerPlant/start',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }   
        function startingPlant() {
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/powerPlant/starting',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
            setTimeout(function(){
                startPlant(); 
            }, 30000); //5000 = 5s
        }  
        function stopPlant() {
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/powerPlant/stop',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });   
        }   
        function setBuffer(production){
            var x = document.getElementById("save").value;
            if(x.length < 1){
                x = 0;
            }else if(x > 100){
                x = 100;
            }else if(x < 0){
                x = 0;
            }
            var save = production*(x/100);
            sendBuffer(save);
        }
        function setPrice(){
            var x = document.getElementById("price").value;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/powerPlant/setPrice',
                data: {price: x},
                dataType: 'json',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
            
        }
        function sendBuffer(save){
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/powerPlant/updateBuffer',
                data: {buffer: save},
                dataType: 'json',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    document.getElementById("buffer").innerHTML = json.newBuffer;
                }
            });
        }
        function logout(){
            const href = window.location.href;
            const auth = href.split('?')[1];
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/statusZero',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    window.location.replace('http://localhost:8000');
                }
            });
        }
        function onlineCheck(){
            userSelected = false;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/onlineCheck',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    $('#online').empty();
                    var length = Object.keys(json.user).length;
                    for(length; length > 0; length--){
                        var x = document.getElementById("online");
                        var option = document.createElement("option");
                        option.text = json.user[length-1].name;
                        x.add(option);
                    }
                }
            });
        }
        function blackOutCheck(){
            userSelected = false;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/blackOutCheck',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    $('#blackOut').empty();
                    var length = Object.keys(json.user).length;
                    for(length; length > 0; length--){
                        var x = document.getElementById("blackOut");
                        var option = document.createElement("option");
                        option.text = json.user[length-1].name;
                        x.add(option);
                    }
                }
            });
        }
        function sendUser(){
            var e = document.getElementById("online");
            name = e.options[e.selectedIndex].text;
            document.getElementById("prosumerName").innerHTML = name;
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/getUserData',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {name: name},
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                   document.getElementById("prosumerBuffer").innerHTML = json.buffer; 
                   document.getElementById("netProduction").innerHTML = Math.round(json.netProduction);
                }
            });
        }
        function blockUser(){
          var name = document.getElementById("prosumerName").innerHTML;
          if(name != ""){
              $.ajax({
                    type: 'post',
                    url: 'http://54.197.39.195:3000/user/blocked',
                    headers: {
                        'Authorization': 'Bearer ' + auth
                    },
                    data: {name: name},
                    dataType: 'json',
                    error: function (data) {
                        console.debug(data);
                    },
                    success: function (json) {
                        setTimeout(function(){
                            unBlock(name);
                        }, 30000); //5000 = 5s
                    }
                });
          }
        }
        function unBlock(name){
            $.ajax({
                type: 'post',
                url: 'http://54.197.39.195:3000/user/unBlocked',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {name: name},
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }
        function setUser(){
            userSelected = true;
        }
        
	</script>

	<h1>Manager</h1>

     <div id="blackOutInfoDiv">
        <p id="blackOutInfo">Users that currently has a black-out: </p>
        <form>
            <select id="blackOut" size="4">
            </select>
        </form>   
    </div>

    <div id="prosumerInfo">
        <p id="topOnline">Online users:</p>
        <form>
            <select id="online" size="4">
            </select>
        </form>   
        <button type="submit" onclick="onlineCheck()">Check who is online</button>

       
        <div id="prosumerDiv">
            <p><p id="prosumerName"></p>'s system:</p><br>
            <p>Net production:</p> <p id="netProduction">0</p> kWh<br>
            <p>Buffer:</p> <p id="prosumerBuffer">0</p> kWh
            <button type="submit" onclick="blockUser()">Block this user</button>
        </div>
    </div>

    <img id="myManagerImg" height="100" width="100" style="display: none">

    <div id="powerPlant"> <p>Status of power plant:</p> <p id="status"></p> </div>
    <div id="productionDiv"> <p>Production:</p> <p id="production"></p> kWh</div>
    <div id="bufferDiv"> <p>Buffer:</p> <p id="buffer"></p> kWh</div>
    <div id="totalnetproductionDiv"> <p>Total net production:</p> <p id="totalNetProduction">0</p> kWh</div>
    <div id="recommendedPriceDiv"> <p>Recommended price:</p> <p id="recommendedPrice">0</p> kr/kWh</div>
    <div id="currentPriceDiv"> <p>Price:</p> <p id="currentPrice">0</p> kr/kWh</div><br>

    <div class="container">
        <button type="submit" onclick="startingPlant()">Start Power Plant</button>
        <button type="submit" onclick="stopPlant()">Stop Power Plant</button>
    </div>

    <div class="container">
        <label for="save"><p id="text" >What percentage of your production would you like to save in the buffer?</p></label>
        <input type="text" placeholder="0" id="save" required>
    </div>

        <div class="container">
            <label for="price"><p>Price per kWh</p></label>
            <input type="text" id="price" required>
            <button type="submit" onclick="setPrice()">Set price</button>
        </div>

    <div id="profile">
        <h2>Update your credentials</h2>
        <div class="container">
            <label for="username"><b>New username</b></label>
            <input type="text" id="username" required>
            <button type="submit" onclick="changeUser()">Change</button>
        </div>

        <div class="container">
            <label for="name"><b>New name</b></label>
            <input type="text" id="name" required>
            <button type="submit" onclick="changeName()">Change</button>
        </div>

        <div class="container">
            <label for="password"><b>New password</b></label>
            <input type="password" id="password" required>
            <button type="submit" onclick="changePass()">Change</button>
        </div>
    </div>

    <div class="container" id="submit">
    <input type="file" id="file" name="file" multiple />
    <button type="submit" onclick="upload()">Upload</button>
    </div> 

    <div class="container" id="logout">
    <button type="submit" onclick="logout()">Logout</button>
    </div>

    <div class="container">
    <button type="submit" onclick="deleteAcc()">Delete Account</button>
    </div>
  </body>
</html>
