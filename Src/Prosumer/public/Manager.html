<!DOCTYPE html>
  <head>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" type="text/javascript">
    </script>
  </head>
  <body>
	<script>
        $(document).ready(function() {
            main(); 
            setInterval(function(){
                main(); 
            }, 10000); //5000 = 5s
        });

        const href = window.location.href;
        const auth = href.split('?')[1];

        function main(){
            $.ajax({
                type: 'get',
                url: 'http://localhost:3000/user/getImage',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    if(typeof json.icon != "undefined"){
                        $("#myImg").attr('src','http://localhost:3000/' + json.icon);
                        $("#myImg").attr('style','');
                    }
                }
            });

            $.ajax({
                type: 'get',
                url: 'http://localhost:3000/powerPlant/status',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    setStatus(json.status);
                }
            });
        }

        function setStatus(status){
            if(status == 0){
                status = "stopped";
                setProduction(0);
            } else if(status == 1){
                status = "starting";
                setProduction(0);
            }else if(status == 2){
                status = "running";
                getProduction();
            }  
            document.getElementById("status").innerHTML = status;
        }
        function getProduction(){
            $.ajax({
                type: 'get',
                url: 'http://localhost:3000/powerPlant/production',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'json',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json){
                    setProduction(json.production);
                }
            });
        }
        function setProduction(production){
            document.getElementById("production").innerHTML = production;
        }
        function upload(){
            var file_data = $('#file').prop('files')[0];
            var form_data = new FormData();
            form_data.append('avatar', file_data);
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/uploadImage',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                cache: false,
                contentType: false,
                processData: false,
                enctype: 'multipart/form-data',
                data: form_data,
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }

        function changeUser() {
            var username = document.getElementById("username").value;
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/changeUser',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {username: username},
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Username has been changed, please login again!')
                    window.location.replace('http://localhost:8000');
                }
            });
        }

        function changeName() {
            var name = document.getElementById("name").value;
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/changeName',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {name: name},
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Name has been changed, please login again!')
                    window.location.replace('http://localhost:8000');
                }
            });
        }

        function changePass() {
            var password = document.getElementById("password").value;
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/changePass',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                data: {password: password},
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Password has been changed, please login again!')
                    window.location.replace('http://localhost:8000');
                }
            });
        }	

        function deleteAcc() {
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/delete',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                    alert('Your account has been deleted')
                    window.location.replace('http://localhost:8000');
                }
            });
        }	

        function startPlant() {
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/powerPlant/start',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }   

        function startingPlant() {
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/powerPlant/starting',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
            setTimeout(function(){
                startPlant(); 
            }, 30000); //5000 = 5s
        }  

        function stopPlant() {
            $.ajax({
                type: 'post',
                url: 'http://localhost:3000/powerPlant/stop',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                }
            });
        }   
	</script>

	<h1>Manager</h1>

    <div class="container" id="submit">
    <input type="file" id="file" name="file" multiple />
    <button type="submit" onclick="upload()">Upload</button>
    </div> 

    <div class="container">
    <label for="username"><b>New username</b></label>
    <input type="text" id="username" required>
    <button type="submit" onclick="changeUser()">Change</button>
    </div>

    <div class="container">
    <label for="name"><b>New name</b></label>
    <input type="text" id="name" required>
    <button type="submit" onclick="changeName()">Change</button>
    </div>

    <div class="container">
    <label for="password"><b>New password</b></label>
    <input type="password" id="password" required>
    <button type="submit" onclick="changePass()">Change</button>
    </div>

    <div class="container">
    <button type="submit" onclick="deleteAcc()">Delete Account</button>
    </div>

    <div id="powerPlant"> <p>Status of power plant:</p> <p id="status"></p> </div>
     <div id="productionDiv"> <p>Production:</p> <p id="production"></p> kWh</div>

    <div class="container">
    <button type="submit" onclick="startingPlant()">Start Power Plant</button>
    <button type="submit" onclick="stopPlant()">Stop Power Plant</button>
    </div>

    <img id="myImg" height="100" width="100" style="display: none">
	
  </body>
</html>
