<!DOCTYPE html>
  <head>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" type="text/javascript">
    </script>
  </head>

  <body>

	<script>
		$(document).ready(function() {
			main(); 
			setInterval(function(){
    			main(); 
			}, 1000); //5000 = 5s
		});

		function main(){
			const href = window.location.href;
			const auth = href.split('?')[1];
			$.ajax({
                type: 'get',
                url: 'http://localhost:3000/electricityConsumption',
                headers: {
                	'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                   setConsumption(json.elecConsumption);
                }
            });

			$.ajax({
                type: 'get',
                url: 'http://localhost:3000/user/getImage',
                headers: {
                	'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                   //json.icon 
      				if(typeof json.icon != "undefined"){
                   		$("#myImg").attr('src','http://localhost:3000/' + json.icon);
                   		$("#myImg").attr('style','');
                	}
                }
            });

            $.ajax({
                type: 'get',
                url: 'http://localhost:3000/weather/dailyWeather',
                headers: {
                	'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                  	$.ajax({
		                type: 'post',
		                url: 'http://localhost:3000/weather/currentWeather',
		                data: {dailyWeather: json.dailyWeather},
		                dataType: 'json',
		                headers: {
		                	'Authorization': 'Bearer ' + auth
		                },
		                error: function (data) {
		                    console.debug(data);
		                },
		                success: function (json) {
		                  	setWind(json.currentWeather);	
							setProduction(json.currentWeather);
							setNetProduction(json.currentWeather);
		                }
		     	   });
                }
            });
		}


		function setConsumption(elecConsumption){
			document.getElementById("consumption").innerHTML = Math.round(elecConsumption*10);
		}
		function setWind(wind){
			document.getElementById("wind").innerHTML = Math.round(wind*10)/10;
		}
		function setProduction(wind){
			document.getElementById("production").innerHTML = Math.round(wind*10);
		}
		function setNetProduction(wind){
			var y = wind*10 - Number(document.getElementById("consumption").innerHTML);
			document.getElementById("netProduction").innerHTML = Math.round(y);
			setBuffer(y);
		}
		function setBuffer(production){
			var x;
			if(production > 0){
				x = document.getElementById("save").value;
				if(x.length < 1){
					x = 0;
				}else if(x > 100){
					x = 100;
				}else if(x < 0){
					x = 0;
				}
				var save = production*(x/100);
				sendBuffer(save, production);
			}else{
				x = document.getElementById("buy").value;
				if(x.length < 1){
					x = 0;
				}else if(x > 100){
					x = 100;
				}else if(x < 0){
					x = 0;
				}
				var save = production*(x/100);
				getBuffer(save, production);
			}
		}
		function getBuffer(save, production){
			const href = window.location.href;
			const auth = href.split('?')[1];
			$.ajax({
                type: 'get',
                url: 'http://localhost:3000/user/getBuffer',
                dataType: 'json',
                headers: {
                	'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                	if(save + json.currentBuffer < 0){
                		sendBuffer(-json.currentBuffer, production);   
                	} else {
                		sendBuffer(save, production);
                	}
                }
            });
		}
		function sendBuffer(value, production){
			const href = window.location.href;
			const auth = href.split('?')[1];
			$.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/updateBuffer',
                data: {buffer: value},
		        dataType: 'json',
                headers: {
                	'Authorization': 'Bearer ' + auth
                },
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                	document.getElementById("buffer").innerHTML = json.newBuffer;
                	setPrice(value, production);
                }
            });
		}
		function setPrice(buffer, production){
			document.getElementById("price").innerHTML = Math.round((production - buffer)*1);
		}
		function logout(){
			window.location.replace('http://localhost:8000');
		}
		function upload(){
			const href = window.location.href;
			const auth = href.split('?')[1];
			var file_data = $('#file').prop('files')[0];
            var form_data = new FormData();
            form_data.append('avatar', file_data);
			$.ajax({
                type: 'post',
                url: 'http://localhost:3000/user/uploadImage',
                headers: {
                	'Authorization': 'Bearer ' + auth
                },
                dataType: 'text',
                cache: false,
                contentType: false,
                processData: false,
                enctype: 'multipart/form-data',
                data: form_data,
                error: function (data) {
                    console.debug(data);
                },
                success: function (json) {
                  // setConsumption(json.elecConsumption);
                }
            });
		}
	</script>

	<h1>Green Lean Electrics</h1>

	<img id="myImg" height="100" width="100" style="display: none">

	<div id="windDiv"> <p>Current wind:</p> <p id="wind"></p> <p>m/s</p> </div>
	<div id="productionDiv"><p>Current production: <p id="production"></p> kWh</p></div>
	<div id="consumptionDiv"><p>Current consumption: <p id="consumption"></p> kWh</p></div>
	<div id="netProductionDiv"><p>Net production: <p id="netProduction"></p> kWh</p></div>
	<div id="bufferDiv"><p>Buffer: <p id="buffer"></p> kWh</p></div>
	<div id="priceDiv"><p>Current electricity price: <p id="price"></p> kr</p></div>

	<div class="container">
    <label for="save"><p>What percentage of your overproduction would you like to save in the buffer?</p></label>
    <input type="text" placeholder="0" id="save" required>
	</div>
	<div class="container">
    <label for="buy"><p>What percentage of your underproduction would you like to take from the buffer?</p></label>
    <input type="text" placeholder="0" id="buy" required>
	</div>

	<div class="container" id="submit">
	<input type="file" id="file" name="file" multiple />
    <button type="submit" onclick="upload()">Upload</button>
	</div> 

	<div class="container" id="logout">
    <button type="submit" onclick="logout()">Logout</button>
	</div>

  </body>
</html>
